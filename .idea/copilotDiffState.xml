<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/.dockerignore">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/.dockerignore" />
              <option name="originalContent" value="# Dependencies&#10;node_modules&#10;&#10;# Next build output&#10;.next&#10;out&#10;&#10;# Logs&#10;npm-debug.log*&#10;yarn-debug.log*&#10;yarn-error.log*&#10;&#10;# Env files (keep out of images)&#10;.env&#10;.env.*&#10;&#10;# Git and CI&#10;.git&#10;.github&#10;&#10;" />
              <option name="updatedContent" value="# Dependencies&#10;node_modules&#10;&#10;# Next build output&#10;.next&#10;out&#10;&#10;# Logs&#10;npm-debug.log*&#10;yarn-debug.log*&#10;yarn-error.log*&#10;&#10;# Env files (keep out of images)&#10;.env&#10;.env.*&#10;&#10;# Git and CI&#10;.git&#10;.github&#10;&#10;# IDE&#10;.idea&#10;.vscode&#10;&#10;# Testing&#10;*.test.js&#10;*.spec.js&#10;__tests__&#10;coverage&#10;&#10;# Documentation&#10;README.md&#10;docs&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/.github/workflows/deploy.yml">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/.github/workflows/deploy.yml" />
              <option name="originalContent" value="name: Deploy to ECS&#10;&#10;on:&#10;  push:&#10;    branches:&#10;      - '**'&#10;&#10;env:&#10;  AWS_REGION: ${{ vars.AWS_REGION }}&#10;  ECS_CLUSTER: ${{ vars.ECS_CLUSTER_PRODUCTION }}&#10;  ECS_SERVICE: ${{ vars.ECS_SERVICE_PRODUCTION }}&#10;&#10;jobs:&#10;  #  Code Quality Scan&#10;  sonarcloud:&#10;    name: Code Quality Analysis&#10;    runs-on: ubuntu-latest&#10;    permissions:&#10;      contents: read&#10;      pull-requests: write&#10;    steps:&#10;      - uses: actions/checkout@v4&#10;        with:&#10;          fetch-depth: 0&#10;&#10;      - name: SonarQube Scan&#10;        uses: SonarSource/sonarqube-scan-action@v5.0.0&#10;        env:&#10;          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}&#10;          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}&#10;          SONAR_HOST_URL: https://sonarcloud.io&#10;        continue-on-error: true&#10;&#10;  # Security Scan&#10;  codeql:&#10;    name: Security Analysis&#10;    runs-on: ubuntu-latest&#10;    permissions:&#10;      security-events: write&#10;      contents: read&#10;      actions: read&#10;    steps:&#10;      - uses: actions/checkout@v4&#10;&#10;      - name: Initialize CodeQL&#10;        uses: github/codeql-action/init@v3&#10;        with:&#10;          languages: javascript-typescript&#10;&#10;      - name: Perform CodeQL Analysis&#10;        uses: github/codeql-action/analyze@v3&#10;        with:&#10;          category: &quot;/language:javascript-typescript&quot;&#10;        continue-on-error: true&#10;&#10;  build-and-deploy:&#10;    runs-on: ubuntu-latest&#10;    permissions:&#10;      contents: read&#10;      id-token: write&#10;    steps:&#10;      - name: Checkout&#10;        uses: actions/checkout@v4&#10;&#10;      - name: Verify and Trim ECS Variables&#10;        id: ecs-vars&#10;        shell: bash&#10;        run: |&#10;          CLUSTER_NAME=$(echo &quot;${{ vars.ECS_CLUSTER_PRODUCTION }}&quot; | xargs)&#10;          SERVICE_NAME=$(echo &quot;${{ vars.ECS_SERVICE_PRODUCTION }}&quot; | xargs)&#10;          &#10;          if [ -z &quot;$CLUSTER_NAME&quot; ]; then&#10;            echo &quot;::error::ECS_CLUSTER_PRODUCTION variable is not set or is empty.&quot;&#10;            exit 1&#10;          fi&#10;          &#10;          if [ -z &quot;$SERVICE_NAME&quot; ]; then&#10;            echo &quot;::error::ECS_SERVICE_PRODUCTION variable is not set or is empty.&quot;&#10;            exit 1&#10;          fi&#10;          &#10;          echo &quot;cluster_name=$CLUSTER_NAME&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;&#10;          echo &quot;service_name=$SERVICE_NAME&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;&#10;          echo &quot;ECS Cluster and Service names are present.&quot;&#10;&#10;      - name: Configure AWS credentials&#10;        uses: aws-actions/configure-aws-credentials@v4&#10;        with:&#10;          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}&#10;          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}&#10;          aws-region: ${{ vars.AWS_REGION }}&#10;&#10;      - name: Login to Amazon ECR&#10;        id: login-ecr&#10;        uses: aws-actions/amazon-ecr-login@v2&#10;&#10;      - name: Compute image repository&#10;        id: repo&#10;        shell: bash&#10;        run: |&#10;          REPO_INPUT='${{ secrets.ECR_REPOSITORY }}'&#10;          REG='${{ steps.login-ecr.outputs.registry }}'&#10;          if [[ &quot;$REPO_INPUT&quot; == *&quot;amazonaws.com&quot;* ]]; then&#10;            IMAGE_REPO=&quot;$REPO_INPUT&quot;&#10;          else&#10;            IMAGE_REPO=&quot;$REG/$REPO_INPUT&quot;&#10;          fi&#10;          echo &quot;image=$IMAGE_REPO&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;Using image repository: $IMAGE_REPO&quot;&#10;&#10;      - name: Extract Docker metadata&#10;        id: meta&#10;        uses: docker/metadata-action@v5&#10;        with:&#10;          images: ${{ steps.repo.outputs.image }}&#10;          tags: |&#10;            type=sha&#10;            type=raw,value=latest&#10;&#10;      - name: Build and push Docker image&#10;        uses: docker/build-push-action@v6&#10;        with:&#10;          context: .&#10;          push: true&#10;          tags: ${{ steps.meta.outputs.tags }}&#10;          labels: ${{ steps.meta.outputs.labels }}&#10;          build-args: |&#10;            DATABASE_URL=${{ secrets.DATABASE_URL }}&#10;            NEXT_PUBLIC_WORKOS_REDIRECT_URI=${{ vars.NEXT_PUBLIC_WORKOS_REDIRECT_URI }}&#10;            WORKOS_COOKIE_PASSWORD=${{ secrets.WORKOS_COOKIE_PASSWORD }}&#10;&#10;      - name: Install jq&#10;        run: sudo apt-get update &amp;&amp; sudo apt-get install -y jq&#10;&#10;      - name: Resolve new image tag&#10;        id: image&#10;        shell: bash&#10;        run: |&#10;          SHA_TAG=$(echo &quot;${{ steps.meta.outputs.tags }}&quot; | tr ' ' '\n' | grep &quot;:sha-&quot; | head -n1)&#10;          if [ -z &quot;$SHA_TAG&quot; ]; then&#10;            echo &quot;Failed to resolve SHA tag from metadata&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;          echo &quot;tag=${SHA_TAG}&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;repo_base=${SHA_TAG%%:*}&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;Using image: ${SHA_TAG}&quot;&#10;&#10;      ## ️ Prisma Database Migration&#10;&#10;      - name: Setup Node.js for Prisma&#10;        uses: actions/setup-node@v4&#10;        with:&#10;          node-version: '20'&#10;          cache: 'npm'&#10;&#10;      - name: Install Dependencies for Prisma&#10;        run: npm ci --legacy-peer-deps&#10;&#10;      - name: Run Prisma Migrations&#10;        run: npx prisma migrate deploy&#10;        env:&#10;          DATABASE_URL: ${{ secrets.DATABASE_URL }}&#10;          DIRECT_URL: ${{ secrets.DIRECT_URL }}&#10;&#10;      ##  ECS Deployment&#10;&#10;      - name: Describe current task definition&#10;        id: describe-td&#10;        run: |&#10;          echo &quot;Describing service '${{ steps.ecs-vars.outputs.service_name }}' in cluster '${{ steps.ecs-vars.outputs.cluster_name }}'...&quot;&#10;          SERVICE_DESC=$(aws ecs describe-services --cluster &quot;${{ steps.ecs-vars.outputs.cluster_name }}&quot; --services &quot;${{ steps.ecs-vars.outputs.service_name }}&quot;)&#10;          TASK_DEF_ARN=$(echo &quot;$SERVICE_DESC&quot; | jq -r '.services[0].taskDefinition')&#10;          if [ -z &quot;$TASK_DEF_ARN&quot; ] || [ &quot;$TASK_DEF_ARN&quot; = &quot;null&quot; ]; then&#10;            echo &quot;Could not resolve current task definition ARN&quot; &gt;&amp;2&#10;            echo &quot;$SERVICE_DESC&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;          aws ecs describe-task-definition --task-definition &quot;$TASK_DEF_ARN&quot; --query 'taskDefinition' &gt; td.json&#10;          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' td.json &gt; td.stripped.json&#10;          echo &quot;task_def_file=td.stripped.json&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;&#10;&#10;      - name: Update container image and inject environment variables&#10;        id: render-td&#10;        shell: bash&#10;        run: |&#10;          IMAGE=&quot;${{ steps.image.outputs.tag }}&quot;&#10;          REPO_BASE=&quot;${{ steps.image.outputs.repo_base }}&quot;&#10;          TD_FILE=&quot;${{ steps.describe-td.outputs.task_def_file }}&quot;&#10;&#10;          echo &quot;Updating to image: $IMAGE&quot;&#10;&#10;          ENV_VARS_JSON=$(jq -n \&#10;            --arg workos_api_key &quot;${{ secrets.WORKOS_API_KEY }}&quot; \&#10;            --arg workos_client_id &quot;${{ secrets.WORKOS_CLIENT_ID }}&quot; \&#10;            --arg database_url &quot;${{ secrets.DATABASE_URL }}&quot; \&#10;            --arg direct_url &quot;${{ secrets.DIRECT_URL }}&quot; \&#10;            --arg redirect_uri &quot;${{ vars.NEXT_PUBLIC_WORKOS_REDIRECT_URI }}&quot; \&#10;            --arg cookie_password &quot;${{ secrets.WORKOS_COOKIE_PASSWORD }}&quot; \&#10;            --arg aws_region &quot;${{ vars.AWS_REGION }}&quot; \&#10;            --arg aws_access_key_id &quot;${{ secrets.AWS_ACCESS_KEY_ID }}&quot; \&#10;            --arg aws_secret_access_key &quot;${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}&quot; \&#10;            --arg s3_bucket_name &quot;${{ vars.AWS_S3_BUCKET_NAME }}&quot; \&#10;            --arg llm_type &quot;${{ vars.LLM_TYPE }}&quot; \&#10;            --arg llm_endpoint &quot;${{ vars.LLM_ENDPOINT }}&quot; \&#10;            --arg llm_model &quot;${{ vars.LLM_MODEL }}&quot; \&#10;            '[&#10;              {&quot;name&quot;: &quot;APP_BASE_URL&quot;, &quot;value&quot;: &quot;https://hfhackathon.com&quot;},&#10;              {&quot;name&quot;: &quot;DATABASE_URL&quot;, &quot;value&quot;: $database_url},&#10;              {&quot;name&quot;: &quot;DIRECT_URL&quot;, &quot;value&quot;: $direct_url},&#10;              {&quot;name&quot;: &quot;NEXT_PUBLIC_WORKOS_REDIRECT_URI&quot;, &quot;value&quot;: $redirect_uri},&#10;              {&quot;name&quot;: &quot;WORKOS_API_KEY&quot;, &quot;value&quot;: $workos_api_key},&#10;              {&quot;name&quot;: &quot;WORKOS_CLIENT_ID&quot;, &quot;value&quot;: $workos_client_id},&#10;              {&quot;name&quot;: &quot;WORKOS_COOKIE_PASSWORD&quot;, &quot;value&quot;: $cookie_password},&#10;              {&quot;name&quot;: &quot;WORKOS_REDIRECT_URI&quot;, &quot;value&quot;: $redirect_uri},&#10;              {&quot;name&quot;: &quot;AWS_REGION&quot;, &quot;value&quot;: $aws_region},&#10;              {&quot;name&quot;: &quot;AWS_ACCESS_KEY_ID&quot;, &quot;value&quot;: $aws_access_key_id},&#10;              {&quot;name&quot;: &quot;AWS_SECRET_ACCESS_KEY&quot;, &quot;value&quot;: $aws_secret_access_key},&#10;              {&quot;name&quot;: &quot;AWS_S3_BUCKET_NAME&quot;, &quot;value&quot;: $s3_bucket_name},&#10;              {&quot;name&quot;: &quot;LLM_TYPE&quot;, &quot;value&quot;: $llm_type},&#10;              {&quot;name&quot;: &quot;LLM_ENDPOINT&quot;, &quot;value&quot;: $llm_endpoint},&#10;              {&quot;name&quot;: &quot;LLM_MODEL&quot;, &quot;value&quot;: $llm_model}&#10;          &#10;            ]')&#10;&#10;          # Find container index - default to 0&#10;          IDX=$(jq '[.containerDefinitions | to_entries | .[] | select(.value.name == &quot;container-hackathon&quot;) | .key] | first // 0' &quot;$TD_FILE&quot;)&#10;          echo &quot;Updating container at index $IDX&quot;&#10;&#10;          # Update image tag AND set environment variables&#10;          jq --arg image &quot;$IMAGE&quot; --argjson idx &quot;$IDX&quot; \&#10;            --argjson env_vars &quot;$ENV_VARS_JSON&quot; \&#10;            '.containerDefinitions[$idx].image = $image | .containerDefinitions[$idx].environment = $env_vars' \&#10;            &quot;$TD_FILE&quot; &gt; td.rendered.json&#10;&#10;          # Verify the image was updated&#10;          NEW_IMAGE=$(jq -r &quot;.containerDefinitions[$IDX].image&quot; td.rendered.json)&#10;          echo &quot;Verified new image in task def: $NEW_IMAGE&quot;&#10;          &#10;          if [ &quot;$NEW_IMAGE&quot; != &quot;$IMAGE&quot; ]; then&#10;            echo &quot;ERROR: Image was not updated properly!&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;&#10;          echo &quot;rendered=td.rendered.json&quot; &gt;&gt; $GITHUB_OUTPUT&#10;&#10;      - name: Register new task definition&#10;        id: register-td&#10;        run: |&#10;          NEW_TD_JSON=$(aws ecs register-task-definition --cli-input-json file://td.rendered.json)&#10;          NEW_TD_ARN=$(echo &quot;$NEW_TD_JSON&quot; | jq -r '.taskDefinition.taskDefinitionArn')&#10;          if [ -z &quot;$NEW_TD_ARN&quot; ] || [ &quot;$NEW_TD_ARN&quot; = &quot;null&quot; ]; then&#10;            echo &quot;Failed to register new task definition&quot; &gt;&amp;2&#10;            echo &quot;$NEW_TD_JSON&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;          echo &quot;arn=$NEW_TD_ARN&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;Registered new task definition: $NEW_TD_ARN&quot;&#10;&#10;      - name: Update ECS service to new task definition&#10;        run: |&#10;          aws ecs update-service \&#10;            --cluster &quot;${{ steps.ecs-vars.outputs.cluster_name }}&quot; \&#10;            --service &quot;${{ steps.ecs-vars.outputs.service_name }}&quot; \&#10;            --task-definition &quot;${{ steps.register-td.outputs.arn }}&quot; \&#10;            --force-new-deployment&#10;          echo &quot;Service updated successfully&quot;" />
              <option name="updatedContent" value="name: Deploy to ECS&#10;&#10;on:&#10;  push:&#10;    branches:&#10;      - '**'&#10;&#10;env:&#10;  AWS_REGION: ${{ vars.AWS_REGION }}&#10;  ECS_CLUSTER: ${{ vars.ECS_CLUSTER_PRODUCTION }}&#10;  ECS_SERVICE: ${{ vars.ECS_SERVICE_PRODUCTION }}&#10;&#10;jobs:&#10;  #  Code Quality Scan&#10;  sonarcloud:&#10;    name: Code Quality Analysis&#10;    runs-on: ubuntu-latest&#10;    permissions:&#10;      contents: read&#10;      pull-requests: write&#10;    steps:&#10;      - uses: actions/checkout@v4&#10;        with:&#10;          fetch-depth: 0&#10;&#10;      - name: SonarQube Scan&#10;        uses: SonarSource/sonarqube-scan-action@v5.0.0&#10;        env:&#10;          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}&#10;          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}&#10;          SONAR_HOST_URL: https://sonarcloud.io&#10;        continue-on-error: true&#10;&#10;  # Security Scan&#10;  codeql:&#10;    name: Security Analysis&#10;    runs-on: ubuntu-latest&#10;    permissions:&#10;      security-events: write&#10;      contents: read&#10;      actions: read&#10;    steps:&#10;      - uses: actions/checkout@v4&#10;&#10;      - name: Initialize CodeQL&#10;        uses: github/codeql-action/init@v3&#10;        with:&#10;          languages: javascript-typescript&#10;&#10;      - name: Perform CodeQL Analysis&#10;        uses: github/codeql-action/analyze@v3&#10;        with:&#10;          category: &quot;/language:javascript-typescript&quot;&#10;        continue-on-error: true&#10;&#10;  build-and-deploy:&#10;    runs-on: ubuntu-latest&#10;    permissions:&#10;      contents: read&#10;      id-token: write&#10;    steps:&#10;      - name: Checkout&#10;        uses: actions/checkout@v4&#10;&#10;      - name: Verify and Trim ECS Variables&#10;        id: ecs-vars&#10;        shell: bash&#10;        run: |&#10;          CLUSTER_NAME=$(echo &quot;${{ vars.ECS_CLUSTER_PRODUCTION }}&quot; | xargs)&#10;          SERVICE_NAME=$(echo &quot;${{ vars.ECS_SERVICE_PRODUCTION }}&quot; | xargs)&#10;          &#10;          if [ -z &quot;$CLUSTER_NAME&quot; ]; then&#10;            echo &quot;::error::ECS_CLUSTER_PRODUCTION variable is not set or is empty.&quot;&#10;            exit 1&#10;          fi&#10;          &#10;          if [ -z &quot;$SERVICE_NAME&quot; ]; then&#10;            echo &quot;::error::ECS_SERVICE_PRODUCTION variable is not set or is empty.&quot;&#10;            exit 1&#10;          fi&#10;          &#10;          echo &quot;cluster_name=$CLUSTER_NAME&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;&#10;          echo &quot;service_name=$SERVICE_NAME&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;&#10;          echo &quot;ECS Cluster and Service names are present.&quot;&#10;&#10;      - name: Configure AWS credentials&#10;        uses: aws-actions/configure-aws-credentials@v4&#10;        with:&#10;          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}&#10;          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}&#10;          aws-region: ${{ vars.AWS_REGION }}&#10;&#10;      - name: Login to Amazon ECR&#10;        id: login-ecr&#10;        uses: aws-actions/amazon-ecr-login@v2&#10;&#10;      - name: Compute image repository&#10;        id: repo&#10;        shell: bash&#10;        run: |&#10;          REPO_INPUT='${{ secrets.ECR_REPOSITORY }}'&#10;          REG='${{ steps.login-ecr.outputs.registry }}'&#10;          if [[ &quot;$REPO_INPUT&quot; == *&quot;amazonaws.com&quot;* ]]; then&#10;            IMAGE_REPO=&quot;$REPO_INPUT&quot;&#10;          else&#10;            IMAGE_REPO=&quot;$REG/$REPO_INPUT&quot;&#10;          fi&#10;          echo &quot;image=$IMAGE_REPO&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;Using image repository: $IMAGE_REPO&quot;&#10;&#10;      - name: Extract Docker metadata&#10;        id: meta&#10;        uses: docker/metadata-action@v5&#10;        with:&#10;          images: ${{ steps.repo.outputs.image }}&#10;          tags: |&#10;            type=sha&#10;            type=raw,value=latest&#10;&#10;      - name: Build and push Docker image&#10;        uses: docker/build-push-action@v6&#10;        with:&#10;          context: .&#10;          file: ./Dockerfile&#10;          push: true&#10;          tags: ${{ steps.meta.outputs.tags }}&#10;          labels: ${{ steps.meta.outputs.labels }}&#10;          build-args: |&#10;            DATABASE_URL=${{ secrets.DATABASE_URL }}&#10;            NEXT_PUBLIC_WORKOS_REDIRECT_URI=${{ vars.NEXT_PUBLIC_WORKOS_REDIRECT_URI }}&#10;            WORKOS_COOKIE_PASSWORD=${{ secrets.WORKOS_COOKIE_PASSWORD }}&#10;&#10;      - name: Install jq&#10;        run: sudo apt-get update &amp;&amp; sudo apt-get install -y jq&#10;&#10;      - name: Resolve new image tag&#10;        id: image&#10;        shell: bash&#10;        run: |&#10;          SHA_TAG=$(echo &quot;${{ steps.meta.outputs.tags }}&quot; | tr ' ' '\n' | grep &quot;:sha-&quot; | head -n1)&#10;          if [ -z &quot;$SHA_TAG&quot; ]; then&#10;            echo &quot;Failed to resolve SHA tag from metadata&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;          echo &quot;tag=${SHA_TAG}&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;repo_base=${SHA_TAG%%:*}&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;Using image: ${SHA_TAG}&quot;&#10;&#10;      ## ️ Prisma Database Migration&#10;&#10;      - name: Setup Node.js for Prisma&#10;        uses: actions/setup-node@v4&#10;        with:&#10;          node-version: '20'&#10;          cache: 'npm'&#10;&#10;      - name: Install Dependencies for Prisma&#10;        run: npm ci --legacy-peer-deps&#10;&#10;      - name: Run Prisma Migrations&#10;        run: npx prisma migrate deploy&#10;        env:&#10;          DATABASE_URL: ${{ secrets.DATABASE_URL }}&#10;          DIRECT_URL: ${{ secrets.DIRECT_URL }}&#10;&#10;      ##  ECS Deployment&#10;&#10;      - name: Describe current task definition&#10;        id: describe-td&#10;        run: |&#10;          echo &quot;Describing service '${{ steps.ecs-vars.outputs.service_name }}' in cluster '${{ steps.ecs-vars.outputs.cluster_name }}'...&quot;&#10;          SERVICE_DESC=$(aws ecs describe-services --cluster &quot;${{ steps.ecs-vars.outputs.cluster_name }}&quot; --services &quot;${{ steps.ecs-vars.outputs.service_name }}&quot;)&#10;          TASK_DEF_ARN=$(echo &quot;$SERVICE_DESC&quot; | jq -r '.services[0].taskDefinition')&#10;          if [ -z &quot;$TASK_DEF_ARN&quot; ] || [ &quot;$TASK_DEF_ARN&quot; = &quot;null&quot; ]; then&#10;            echo &quot;Could not resolve current task definition ARN&quot; &gt;&amp;2&#10;            echo &quot;$SERVICE_DESC&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;          aws ecs describe-task-definition --task-definition &quot;$TASK_DEF_ARN&quot; --query 'taskDefinition' &gt; td.json&#10;          jq 'del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .compatibilities, .registeredAt, .registeredBy)' td.json &gt; td.stripped.json&#10;          echo &quot;task_def_file=td.stripped.json&quot; &gt;&gt; &quot;$GITHUB_OUTPUT&quot;&#10;&#10;      - name: Update container image and inject environment variables&#10;        id: render-td&#10;        shell: bash&#10;        run: |&#10;          IMAGE=&quot;${{ steps.image.outputs.tag }}&quot;&#10;          REPO_BASE=&quot;${{ steps.image.outputs.repo_base }}&quot;&#10;          TD_FILE=&quot;${{ steps.describe-td.outputs.task_def_file }}&quot;&#10;&#10;          echo &quot;Updating to image: $IMAGE&quot;&#10;&#10;          ENV_VARS_JSON=$(jq -n \&#10;            --arg workos_api_key &quot;${{ secrets.WORKOS_API_KEY }}&quot; \&#10;            --arg workos_client_id &quot;${{ secrets.WORKOS_CLIENT_ID }}&quot; \&#10;            --arg database_url &quot;${{ secrets.DATABASE_URL }}&quot; \&#10;            --arg direct_url &quot;${{ secrets.DIRECT_URL }}&quot; \&#10;            --arg redirect_uri &quot;${{ vars.NEXT_PUBLIC_WORKOS_REDIRECT_URI }}&quot; \&#10;            --arg cookie_password &quot;${{ secrets.WORKOS_COOKIE_PASSWORD }}&quot; \&#10;            --arg aws_region &quot;${{ vars.AWS_REGION }}&quot; \&#10;            --arg aws_access_key_id &quot;${{ secrets.AWS_ACCESS_KEY_ID }}&quot; \&#10;            --arg aws_secret_access_key &quot;${{ secrets.AWS_SECRET_ACCESS_KEY_ID }}&quot; \&#10;            --arg s3_bucket_name &quot;${{ vars.AWS_S3_BUCKET_NAME }}&quot; \&#10;            --arg llm_type &quot;${{ vars.LLM_TYPE }}&quot; \&#10;            --arg llm_endpoint &quot;${{ vars.LLM_ENDPOINT }}&quot; \&#10;            --arg llm_model &quot;${{ vars.LLM_MODEL }}&quot; \&#10;            '[&#10;              {&quot;name&quot;: &quot;APP_BASE_URL&quot;, &quot;value&quot;: &quot;https://hfhackathon.com&quot;},&#10;              {&quot;name&quot;: &quot;DATABASE_URL&quot;, &quot;value&quot;: $database_url},&#10;              {&quot;name&quot;: &quot;DIRECT_URL&quot;, &quot;value&quot;: $direct_url},&#10;              {&quot;name&quot;: &quot;NEXT_PUBLIC_WORKOS_REDIRECT_URI&quot;, &quot;value&quot;: $redirect_uri},&#10;              {&quot;name&quot;: &quot;WORKOS_API_KEY&quot;, &quot;value&quot;: $workos_api_key},&#10;              {&quot;name&quot;: &quot;WORKOS_CLIENT_ID&quot;, &quot;value&quot;: $workos_client_id},&#10;              {&quot;name&quot;: &quot;WORKOS_COOKIE_PASSWORD&quot;, &quot;value&quot;: $cookie_password},&#10;              {&quot;name&quot;: &quot;WORKOS_REDIRECT_URI&quot;, &quot;value&quot;: $redirect_uri},&#10;              {&quot;name&quot;: &quot;AWS_REGION&quot;, &quot;value&quot;: $aws_region},&#10;              {&quot;name&quot;: &quot;AWS_ACCESS_KEY_ID&quot;, &quot;value&quot;: $aws_access_key_id},&#10;              {&quot;name&quot;: &quot;AWS_SECRET_ACCESS_KEY&quot;, &quot;value&quot;: $aws_secret_access_key},&#10;              {&quot;name&quot;: &quot;AWS_S3_BUCKET_NAME&quot;, &quot;value&quot;: $s3_bucket_name},&#10;              {&quot;name&quot;: &quot;LLM_TYPE&quot;, &quot;value&quot;: $llm_type},&#10;              {&quot;name&quot;: &quot;LLM_ENDPOINT&quot;, &quot;value&quot;: $llm_endpoint},&#10;              {&quot;name&quot;: &quot;LLM_MODEL&quot;, &quot;value&quot;: $llm_model}&#10;          &#10;            ]')&#10;&#10;          # Find container index - default to 0&#10;          IDX=$(jq '[.containerDefinitions | to_entries | .[] | select(.value.name == &quot;container-hackathon&quot;) | .key] | first // 0' &quot;$TD_FILE&quot;)&#10;          echo &quot;Updating container at index $IDX&quot;&#10;&#10;          # Update image tag AND set environment variables&#10;          jq --arg image &quot;$IMAGE&quot; --argjson idx &quot;$IDX&quot; \&#10;            --argjson env_vars &quot;$ENV_VARS_JSON&quot; \&#10;            '.containerDefinitions[$idx].image = $image | .containerDefinitions[$idx].environment = $env_vars' \&#10;            &quot;$TD_FILE&quot; &gt; td.rendered.json&#10;&#10;          # Verify the image was updated&#10;          NEW_IMAGE=$(jq -r &quot;.containerDefinitions[$IDX].image&quot; td.rendered.json)&#10;          echo &quot;Verified new image in task def: $NEW_IMAGE&quot;&#10;          &#10;          if [ &quot;$NEW_IMAGE&quot; != &quot;$IMAGE&quot; ]; then&#10;            echo &quot;ERROR: Image was not updated properly!&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;&#10;          echo &quot;rendered=td.rendered.json&quot; &gt;&gt; $GITHUB_OUTPUT&#10;&#10;      - name: Register new task definition&#10;        id: register-td&#10;        run: |&#10;          NEW_TD_JSON=$(aws ecs register-task-definition --cli-input-json file://td.rendered.json)&#10;          NEW_TD_ARN=$(echo &quot;$NEW_TD_JSON&quot; | jq -r '.taskDefinition.taskDefinitionArn')&#10;          if [ -z &quot;$NEW_TD_ARN&quot; ] || [ &quot;$NEW_TD_ARN&quot; = &quot;null&quot; ]; then&#10;            echo &quot;Failed to register new task definition&quot; &gt;&amp;2&#10;            echo &quot;$NEW_TD_JSON&quot; &gt;&amp;2&#10;            exit 1&#10;          fi&#10;          echo &quot;arn=$NEW_TD_ARN&quot; &gt;&gt; $GITHUB_OUTPUT&#10;          echo &quot;Registered new task definition: $NEW_TD_ARN&quot;&#10;&#10;      - name: Update ECS service to new task definition&#10;        run: |&#10;          aws ecs update-service \&#10;            --cluster &quot;${{ steps.ecs-vars.outputs.cluster_name }}&quot; \&#10;            --service &quot;${{ steps.ecs-vars.outputs.service_name }}&quot; \&#10;            --task-definition &quot;${{ steps.register-td.outputs.arn }}&quot; \&#10;            --force-new-deployment&#10;          echo &quot;Service updated successfully&quot;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>